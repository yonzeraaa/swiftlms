"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7815],{7815:(e,o,r)=>{r.d(o,{AuthProvider:()=>l,A:()=>i});var t=r(95155),s=r(12115),a=r(46414),n=r(35695);let c=(0,s.createContext)(void 0);function i(){let e=(0,s.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function l(e){let{children:o}=e,[r,i]=(0,s.useState)({session:null,user:null,isLoading:!0,error:null}),l=(0,a.U)(),u=(0,n.useRouter)(),d=(0,s.useRef)(void 0),h=(0,s.useRef)(void 0),S=(0,s.useRef)(void 0),g=async()=>{try{await l.auth.signOut(),i({session:null,user:null,isLoading:!1,error:null}),u.push("/")}catch(e){console.error("Error signing out:",e)}},m=async()=>{try{console.log("[AuthProvider] Fazendo refresh da sess\xe3o...");let{data:o,error:r}=await l.auth.refreshSession();if(r){var e;console.error("[AuthProvider] Erro no refresh, tentando recuperar do localStorage:",r);let o="sb-".concat((e="https://mdzgnktlsmkjecdbermo.supabase.co",void 0===e)?void 0:e.replace("https://","").replace(".supabase.co",""),"-auth-token"),t=localStorage.getItem(o);if(t)try{let e=JSON.parse(t);if(e.refresh_token){console.log("[AuthProvider] Tentando refresh com token do localStorage");let{data:o,error:r}=await l.auth.refreshSession({refresh_token:e.refresh_token});if(!r&&o.session){i({session:o.session,user:o.user,isLoading:!1,error:null}),S.current&&S.current.postMessage({type:"SESSION_REFRESHED"}),p(o.session);return}}}catch(e){console.error("[AuthProvider] Erro ao processar localStorage:",e)}throw r}o.session&&(i({session:o.session,user:o.user,isLoading:!1,error:null}),S.current&&S.current.postMessage({type:"SESSION_REFRESHED"}),p(o.session))}catch(e){console.error("[AuthProvider] Erro no refresh:",e),i(e=>({...e,error:"Falha ao atualizar sess\xe3o"}))}},p=e=>{if(d.current&&clearTimeout(d.current),!e.expires_at)return;let o=new Date(1e3*e.expires_at).getTime(),r=o-Date.now()-0;r>0&&(console.log("[AuthProvider] Refresh agendado para ".concat(Math.round(r/1e3/60)," minutos")),d.current=setTimeout(()=>{m()},r))};(0,s.useEffect)(()=>{let e=!0,o=function(){if("BroadcastChannel"in window){let e=new BroadcastChannel("auth_storage_sync");return e.onmessage=e=>{if("STORAGE_UPDATED"===e.data.type){let{key:o,value:r}=e.data;localStorage.setItem(o,r);let t="".concat(o,"=").concat(encodeURIComponent(r),"; path=/; max-age=").concat(10800,"; SameSite=Lax").concat("; Domain=".concat(".swiftedu.com.br")).concat("; Secure");document.cookie=t}else if("STORAGE_REMOVED"===e.data.type){let{key:o}=e.data;localStorage.removeItem(o),document.cookie="".concat(o,"=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax")}},()=>e.close()}return()=>{}}();"BroadcastChannel"in window&&(S.current=new BroadcastChannel("auth_sync"),S.current.onmessage=o=>{"SESSION_REFRESHED"===o.data.type&&e&&(console.log("[AuthProvider] Sess\xe3o atualizada em outra aba"),l.auth.getSession().then(e=>{let{data:o}=e,{session:r}=o;r&&i({session:r,user:r.user,isLoading:!1,error:null})}))});let r=async()=>{try{var o,r;!function(){let e="sb-mdzgnktlsmkjecdbermo-auth-token",o=localStorage.getItem(e);if(!o)return console.log("[CookieSync] Sem dados no localStorage");try{let r=JSON.parse(o);if(!r.access_token||!r.refresh_token)return void console.log("[CookieSync] Tokens inv\xe1lidos no localStorage");let t=document.cookie.split(";").map(e=>e.trim()),s=t.some(e=>e.startsWith("sb-access-token=")),a=t.some(e=>e.startsWith("sb-refresh-token="));if(s&&a)console.log("[CookieSync] Cookies j\xe1 existem");else{console.log("[CookieSync] Sincronizando cookies do localStorage");let t="https:"===window.location.protocol?"; Secure; SameSite=Lax; Path=/; Max-Age=".concat(604800):"; SameSite=Lax; Path=/; Max-Age=".concat(604800);document.cookie="sb-access-token=".concat(r.access_token).concat(t),document.cookie="sb-refresh-token=".concat(r.refresh_token).concat(t),document.cookie="".concat(e,"=").concat(encodeURIComponent(o)).concat(t),console.log("[CookieSync] Cookies sincronizados com sucesso")}}catch(e){console.error("[CookieSync] Erro ao sincronizar:",e)}}();let{data:{session:t},error:s}=await l.auth.getSession();if(s&&(console.error("[AuthProvider] Erro ao obter sess\xe3o inicial:",s),!t)){let e="sb-".concat((o="https://mdzgnktlsmkjecdbermo.supabase.co",void 0===o)?void 0:o.replace("https://","").replace(".supabase.co",""),"-auth-token"),r=localStorage.getItem(e);if(r)try{let e=JSON.parse(r);console.log("[AuthProvider] Tentando restaurar sess\xe3o do localStorage");let{data:o}=await l.auth.setSession({access_token:e.access_token,refresh_token:e.refresh_token});o.session&&(t=o.session,console.log("[AuthProvider] Sess\xe3o restaurada com sucesso!"))}catch(e){console.error("[AuthProvider] Erro ao restaurar do localStorage:",e)}}e&&(i({session:t,user:null!=(r=null==t?void 0:t.user)?r:null,isLoading:!1,error:null}),t&&p(t))}catch(o){console.error("[AuthProvider] Erro na inicializa\xe7\xe3o:",o),e&&i(e=>({...e,isLoading:!1,error:"Erro ao inicializar autentica\xe7\xe3o"}))}};h.current=setInterval(()=>{e&&l.auth.getSession().then(e=>{let{data:o}=e,{session:r}=o;if(r&&r.expires_at){let e=new Date(1e3*r.expires_at).getTime()-Date.now();e<0?(console.log("[AuthProvider] Heartbeat: Sess\xe3o pr\xf3xima de expirar, fazendo refresh"),m()):console.log("[AuthProvider] Heartbeat: Sess\xe3o v\xe1lida por mais",Math.round(e/1e3/60),"minutos")}else r||(console.log("[AuthProvider] Heartbeat: Sem sess\xe3o, tentando recuperar"),m())})},3e4);let{data:{subscription:t}}=l.auth.onAuthStateChange(async(o,r)=>{if(console.log("[AuthProvider] Estado de auth mudou:",o),e){var t;i({session:r,user:null!=(t=null==r?void 0:r.user)?t:null,isLoading:!1,error:null}),r&&p(r),S.current&&S.current.postMessage({type:"SESSION_REFRESHED"})}});return r(),()=>{e=!1,t.unsubscribe(),o(),h.current&&clearInterval(h.current),d.current&&clearTimeout(d.current),S.current&&S.current.close()}},[l,u]);let f=async()=>{try{if(r.session&&r.session.expires_at){let e=new Date(1e3*r.session.expires_at).getTime(),o=Date.now();if(e>o+6e4)return r.session}console.log("[AuthProvider] Obtendo sess\xe3o atualizada...");let{data:{session:e},error:o}=await l.auth.getSession();if(o||!e){await m();let{data:{session:e}}=await l.auth.getSession();return e}return e}catch(e){return console.error("[AuthProvider] Erro ao obter sess\xe3o:",e),null}},k={...r,signOut:g,refreshSession:m,getSession:f};return(0,t.jsx)(c.Provider,{value:k,children:o})}}}]);